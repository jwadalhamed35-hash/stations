<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoStation Manager | نظام إدارة المحطات</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Leaflet Maps (Free Open Source Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        
        /* Modern Card Style */
        .dashboard-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }

        .active-nav {
            background-color: #eff6ff;
            color: #2563eb;
            border-right: 4px solid #2563eb;
        }

        /* Marker Colors for Map */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #3b82f6;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
        }
        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        .custom-div-icon i {
            position: absolute;
            width: 22px;
            font-size: 22px;
            left: 0;
            right: 0;
            margin: 10px auto;
            text-align: center;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-slate-900 flex items-center justify-center transition-opacity duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 mb-4">
                    <i class="fa-solid fa-gas-pump text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-800 mb-2">GoStation</h1>
                <p class="text-slate-500 text-sm">نظام إدارة ومتابعة المحطات</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">اسم المستخدم</label>
                    <input type="text" id="usernameInput" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" placeholder="admin">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">كلمة المرور</label>
                    <input type="password" id="passwordInput" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" placeholder="******">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-blue-500/30">تسجيل الدخول</button>
                <p id="loginError" class="text-red-500 text-sm text-center hidden bg-red-50 p-2 rounded-lg">بيانات الدخول غير صحيحة</p>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="hidden flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl flex flex-col z-20 border-l border-slate-100">
            <div class="p-6 border-b border-slate-100 flex flex-col items-center">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white mb-2 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-gas-pump"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">GoStation</h2>
                <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-wider" id="currentUserDisplay">GUEST</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="showPage('dashboard')" id="nav-dashboard" class="w-full text-right p-3.5 rounded-xl hover:bg-slate-50 transition flex items-center gap-3 text-sm font-medium active-nav">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> لوحة المعلومات
                </button>
                <button onclick="showPage('stations')" id="nav-stations" class="w-full text-right p-3.5 rounded-xl hover:bg-slate-50 transition flex items-center gap-3 text-sm font-medium text-slate-600">
                    <i class="fa-solid fa-list w-5 text-center"></i> جدول المحطات
                </button>
                <button onclick="showPage('history')" id="nav-history" class="w-full text-right p-3.5 rounded-xl hover:bg-slate-50 transition flex items-center gap-3 text-sm font-medium text-slate-600">
                    <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i> السجل
                </button>
                <button onclick="showPage('settings')" id="nav-settings" class="w-full text-right p-3.5 rounded-xl hover:bg-slate-50 transition flex items-center gap-3 text-sm font-medium text-slate-600">
                    <i class="fa-solid fa-gear w-5 text-center"></i> الإعدادات
                </button>
            </nav>

            <div class="p-4 border-t border-slate-100 bg-slate-50">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">حالة المزامنة</span>
                    <span id="fileLinkStatus" class="w-2 h-2 rounded-full bg-slate-300" title="غير متصل"></span>
                </div>
                <div class="text-[10px] text-slate-400 mb-3 truncate" id="autoSaveStatus">جاهز</div>
                <button onclick="logout()" class="w-full bg-white border border-red-100 text-red-500 hover:bg-red-50 p-2.5 rounded-lg transition text-xs font-bold flex items-center justify-center gap-2">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> خروج
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-[#f8fafc] p-4 md:p-8 relative">
            
            <!-- Global Header -->
            <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-8 gap-4">
                <div>
                    <h2 id="pageTitle" class="text-3xl font-bold text-slate-800">لوحة المعلومات</h2>
                    <p class="text-slate-500 text-sm mt-1">نظرة عامة على أداء ومواقع المحطات</p>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="downloadTemplate()" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 px-4 py-2.5 rounded-lg shadow-sm text-xs font-bold flex items-center gap-2 transition">
                        <i class="fa-solid fa-file-excel text-green-600"></i> القالب
                    </button>
                    <button onclick="linkAutoSaveFile()" id="btnLinkFile" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-lg shadow-lg shadow-slate-200 text-xs font-bold flex items-center gap-2 transition">
                        <i class="fa-solid fa-link"></i> ربط الحفظ التلقائي
                    </button>
                    <div class="h-8 w-[1px] bg-slate-300 mx-1 hidden xl:block"></div>
                    <button onclick="document.getElementById('excelInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg shadow-lg shadow-blue-200 text-xs font-bold flex items-center gap-2 transition">
                        <i class="fa-solid fa-cloud-arrow-up"></i> استيراد
                    </button>
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(this)">
                    <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-lg shadow-lg shadow-emerald-200 text-xs font-bold flex items-center gap-2 transition">
                        <i class="fa-solid fa-cloud-arrow-down"></i> تصدير
                    </button>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page-section space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- KPI 1 -->
                    <div class="dashboard-card p-6 flex items-center justify-between">
                        <div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">إجمالي المحطات</div>
                            <div class="text-3xl font-bold text-slate-800" id="statTotal">0</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i class="fa-solid fa-gas-pump text-xl"></i>
                        </div>
                    </div>
                    <!-- KPI 2 -->
                    <div class="dashboard-card p-6 flex items-center justify-between">
                        <div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">المحطات المفتوحة</div>
                            <div class="text-3xl font-bold text-emerald-600" id="statOpen">0</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                            <i class="fa-solid fa-door-open text-xl"></i>
                        </div>
                    </div>
                    <!-- KPI 3 -->
                    <div class="dashboard-card p-6 flex items-center justify-between">
                        <div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">تحت التطوير/الإنشاء</div>
                            <div class="text-3xl font-bold text-amber-600" id="statDev">0</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-amber-50 flex items-center justify-center text-amber-600">
                            <i class="fa-solid fa-helmet-safety text-xl"></i>
                        </div>
                    </div>
                    <!-- KPI 4 -->
                    <div class="dashboard-card p-6 flex items-center justify-between">
                        <div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">العقود السارية</div>
                            <div class="text-3xl font-bold text-indigo-600" id="statActiveContracts">0</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600">
                            <i class="fa-solid fa-file-contract text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="dashboard-card overflow-hidden">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-map-location-dot text-blue-500"></i> خريطة انتشار المحطات
                        </h3>
                        <div id="mapLegend" class="flex gap-3 text-[10px]">
                            <!-- Legend items injected by JS -->
                        </div>
                    </div>
                    <div id="stationsMap" class="h-[400px] w-full bg-slate-100 z-0 relative"></div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- 1. Region Chart -->
                    <div class="dashboard-card col-span-1 md:col-span-2 lg:col-span-3 p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm border-l-4 border-blue-500 pl-2">التوزيع حسب المنطقة</h3>
                        <div class="h-72 relative"><canvas id="regionChart"></canvas></div>
                    </div>

                    <!-- 2. Main Cities -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">تصنيف المدن</h3>
                        <div class="h-60 relative"><canvas id="mainCityChart"></canvas></div>
                    </div>

                    <!-- 3. Operation Type -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">نوع التشغيل</h3>
                        <div class="h-60 relative"><canvas id="operationTypeChart"></canvas></div>
                    </div>

                    <!-- 4. Station Status -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">حالة المحطة</h3>
                        <div class="h-60 relative"><canvas id="statusChart"></canvas></div>
                    </div>

                    <!-- 5. Road Type -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">نوع الطريق</h3>
                        <div class="h-60 relative"><canvas id="roadTypeChart"></canvas></div>
                    </div>

                    <!-- 6. Contract Status -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">حالة العقد</h3>
                        <div class="h-60 relative"><canvas id="contractStatusChart"></canvas></div>
                    </div>

                    <!-- 7. Map Status -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">توثيق الخرائط</h3>
                        <div class="h-60 relative"><canvas id="mapStatusChart"></canvas></div>
                    </div>

                    <!-- 8. Branding -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">الهوية</h3>
                        <div class="h-60 relative"><canvas id="brandingChart"></canvas></div>
                    </div>

                    <!-- 9. Fuel Type -->
                    <div class="dashboard-card p-5">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm text-center">أنواع الوقود</h3>
                        <div class="h-60 relative"><canvas id="fuelTypeChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Stations Page (Table) -->
            <div id="page-stations" class="page-section hidden">
                <div class="dashboard-card overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white">
                        <div class="relative w-72">
                            <input type="text" id="searchInput" placeholder="بحث باسم المحطة، المدينة، الرمز..." class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition" onkeyup="renderStationsTable()">
                            <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400"></i>
                        </div>
                        <button onclick="openStationModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-md shadow-blue-200 flex items-center gap-2 text-sm font-bold transition">
                            <i class="fa-solid fa-plus"></i> إضافة محطة
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-100 uppercase text-xs tracking-wider">
                                <tr>
                                    <th class="p-4">الرمز</th>
                                    <th class="p-4">المنطقة</th>
                                    <th class="p-4">المدينة</th>
                                    <th class="p-4">الحي</th>
                                    <th class="p-4">الحالة</th>
                                    <th class="p-4">نوع التشغيل</th>
                                    <th class="p-4 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="stationsTableBody" class="divide-y divide-slate-100 bg-white">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Other pages (History, Settings) container adjustments... -->
            <div id="page-history" class="page-section hidden">
                <div class="dashboard-card p-6">
                    <h3 class="text-lg font-bold mb-6 border-b pb-2">سجل العمليات</h3>
                    <div class="overflow-hidden rounded-xl border border-slate-100">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-bold">
                                <tr>
                                    <th class="p-4 text-right">التوقيت</th>
                                    <th class="p-4 text-right">المستخدم</th>
                                    <th class="p-4 text-right">العملية</th>
                                    <th class="p-4 text-right">التفاصيل</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page-section hidden space-y-6">
                <div class="dashboard-card p-6">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h3 class="text-lg font-bold">إدارة المستخدمين</h3>
                        <button onclick="openUserModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-700">إضافة مستخدم</button>
                    </div>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-slate-500 font-bold">
                            <tr>
                                <th class="p-3 text-right">الاسم</th>
                                <th class="p-3 text-right">كلمة المرور</th>
                                <th class="p-3 text-center">إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals (Station & User) - Same logic, updated style classes -->
    <div id="stationModal" class="fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto border border-slate-100">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur z-10">
                <h3 id="modalTitle" class="text-xl font-bold text-slate-800">بيانات المحطة</h3>
                <button onclick="closeStationModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-times fa-lg"></i></button>
            </div>
            <form id="stationForm" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Group 1 -->
                <div class="col-span-full pb-2 text-blue-600 font-bold text-sm border-b uppercase tracking-wide">المعلومات الأساسية</div>
                <div><label class="label-text">رمز المحطة</label><input type="text" name="code" id="input_code" class="input-field bg-slate-100 text-slate-500 cursor-not-allowed" readonly></div>
                <div><label class="label-text">التسمية السابقة</label><input type="text" name="prevName" class="input-field"></div>
                <div><label class="label-text">المنطقة</label><select name="region" class="input-field"><option>الرياض</option><option>مكة المكرمة</option><option>المدينة المنورة</option><option>القصيم</option><option>الشرقية</option><option>عسير</option><option>تبوك</option><option>حائل</option><option>الحدود الشمالية</option><option>جازان</option><option>نجران</option><option>الباحة</option><option>الجوف</option></select></div>
                <div><label class="label-text">المدينة</label><input type="text" name="city" class="input-field"></div>
                <div><label class="label-text">الحي</label><input type="text" name="district" class="input-field"></div>
                <div><label class="label-text">الشارع</label><input type="text" name="street" class="input-field"></div>
                <div><label class="label-text">ضمن المدن الرئيسية؟</label><select name="isMainCity" class="input-field"><option value="نعم">نعم</option><option value="لا">لا</option></select></div>
                <div><label class="label-text">نوع الطريق</label><select name="roadType" class="input-field"><option>إقليمي</option><option>داخل المدينة</option></select></div>

                <!-- Group 2 -->
                <div class="col-span-full pb-2 mt-2 text-blue-600 font-bold text-sm border-b uppercase tracking-wide">الموقع والإحداثيات</div>
                <div class="col-span-2">
                    <label class="label-text">رابط خرائط قوقل</label>
                    <input type="text" name="mapLink" id="input_mapLink" class="input-field" onchange="parseGoogleCoordinates(this.value)" placeholder="الصق الرابط هنا لاستخراج الإحداثيات">
                </div>
                <div><label class="label-text">التوثيق</label><select name="mapStatus" class="input-field"><option>موثق</option><option>غير موثق</option></select></div>
                <div><label class="label-text">Long (X)</label><input type="text" name="coordX" id="input_coordX" class="input-field bg-slate-50" readonly></div>
                <div><label class="label-text">Lat (Y)</label><input type="text" name="coordY" id="input_coordY" class="input-field bg-slate-50" readonly></div>
                <div><label class="label-text">المساحة (م2)</label><input type="number" name="area" class="input-field"></div>

                <!-- Group 3 -->
                <div class="col-span-full pb-2 mt-2 text-blue-600 font-bold text-sm border-b uppercase tracking-wide">التشغيل</div>
                <div><label class="label-text">الحالة</label><select name="status" class="input-field"><option>مفتوحة</option><option>مغلقة</option><option>تحت التأهيل</option><option>تحت الإنشاء</option><option>تحت التطوير</option></select></div>
                <div><label class="label-text">تاريخ الافتتاح</label><input type="date" name="openingDate" class="input-field"></div>
                <div><label class="label-text">نوع العقد</label><select name="contractType" class="input-field"><option>ساري</option><option>مسودة</option><option>منتهي</option></select></div>
                <div><label class="label-text">نوع التشغيل</label><select name="operationType" class="input-field"><option>تشغيل</option><option>ملك</option><option>تشغيل مظلة فقط</option><option>امتياز تجاري</option></select></div>
                <div><label class="label-text">الهوية</label><select name="branding" class="input-field"><option>مطبقة الهوية</option><option>غير مطبقة الهوية</option></select></div>

                <!-- Group 4 -->
                <div class="col-span-full pb-2 mt-2 text-blue-600 font-bold text-sm border-b uppercase tracking-wide">المالك والمشرف</div>
                <div><label class="label-text">المالك</label><input type="text" name="ownerName" class="input-field"></div>
                <div><label class="label-text">جوال المالك</label><input type="text" name="ownerPhone" class="input-field"></div>
                <div><label class="label-text">المشرف</label><input type="text" name="supervisorName" class="input-field"></div>
                <div><label class="label-text">جوال المشرف</label><input type="text" name="supervisorPhone" class="input-field"></div>

                <!-- Group 5 -->
                <div class="col-span-full pb-2 mt-2 text-blue-600 font-bold text-sm border-b uppercase tracking-wide">الوقود والروابط</div>
                <div class="col-span-full">
                    <label class="label-text mb-2">نوع الوقود</label>
                    <div class="flex gap-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="fuelType" value="91" class="accent-blue-600"> 91</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="fuelType" value="95" class="accent-blue-600"> 95</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="fuelType" value="98" class="accent-blue-600"> 98</label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="fuelType" value="D" class="accent-blue-600"> ديزل</label>
                    </div>
                </div>
                <div class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="label-text">رابط العقد</label><input type="url" name="eContractLink" class="input-field"></div>
                    <div><label class="label-text">رابط الملفات</label><input type="url" name="filesLink" class="input-field"></div>
                    <div><label class="label-text">رابط الصور</label><input type="url" name="photosLink" class="input-field"></div>
                    <div><label class="label-text">رابط التقييم</label><input type="url" name="ratingLink" class="input-field"></div>
                </div>
            </form>
            <div class="p-6 border-t bg-slate-50 flex justify-end gap-3 sticky bottom-0">
                <button onclick="closeStationModal()" class="px-6 py-2.5 rounded-lg text-slate-600 font-bold hover:bg-slate-200 transition">إلغاء</button>
                <button onclick="saveStation()" class="px-6 py-2.5 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition">حفظ البيانات</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="fixed inset-0 z-[60] bg-slate-900/50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-lg p-6 w-96">
            <h3 class="text-lg font-bold mb-4">مستخدم جديد</h3>
            <input type="text" id="newUsername" placeholder="اسم المستخدم" class="input-field mb-3">
            <input type="text" id="newPassword" placeholder="كلمة المرور" class="input-field mb-3">
            <div class="flex justify-end gap-2">
                <button onclick="closeUserModal()" class="px-4 py-2 text-slate-500">إلغاء</button>
                <button onclick="saveUser()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">حفظ</button>
            </div>
        </div>
    </div>

    <style>
        .label-text { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 0.35rem; text-transform: uppercase; }
        .input-field { width: 100%; padding: 0.6rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.875rem; color: #1e293b; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>

    <script>
        // --- Configuration: Professional Color Palette ---
        const colors = {
            primary: '#3b82f6', // Blue 500
            secondary: '#64748b', // Slate 500
            success: '#10b981', // Emerald 500
            warning: '#f59e0b', // Amber 500
            danger: '#ef4444', // Red 500
            info: '#06b6d4', // Cyan 500
            purple: '#8b5cf6', // Violet 500
            pink: '#ec4899', // Pink 500
            orange: '#f97316', // Orange 500
            slate: '#1e293b' // Slate 800
        };

        // Operation Type Colors for Map Markers
        const opTypeColors = {
            'تشغيل': colors.primary,
            'ملك': colors.success,
            'امتياز تجاري': colors.warning,
            'تشغيل مظلة فقط': colors.purple,
            'أخرى': colors.secondary
        };

        // --- 1. Global State ---
        let currentUser = null;
        let stations = [];
        let logs = [];
        let users = [{ username: 'admin', password: '123456' }];
        let fileHandle = null;
        let mapInstance = null;
        let markersLayer = null;

        // --- Init ---
        Chart.register(ChartDataLabels);
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setInterval(autoSaveSystem, 10000);
        });

        // --- Authentication ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('usernameInput').value;
            const p = document.getElementById('passwordInput').value;
            const user = users.find(x => x.username === u && x.password === p);
            
            if (user) {
                currentUser = user;
                document.getElementById('currentUserDisplay').textContent = u;
                document.getElementById('loginOverlay').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => document.getElementById('loginOverlay').style.display = 'none', 300);
                document.getElementById('appContainer').classList.remove('hidden');
                addLog('دخول', `تسجيل دخول: ${u}`);
                updateDashboard();
                
                // Initialize Map after layout is visible
                setTimeout(initMap, 500); 
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        function logout() { location.reload(); }

        // --- Data Handling ---
        function loadData() {
            const s = localStorage.getItem('gs_stations');
            if (s) stations = JSON.parse(s);
            const l = localStorage.getItem('gs_logs');
            if (l) logs = JSON.parse(l);
            const u = localStorage.getItem('gs_users');
            if (u) users = JSON.parse(u);
            
            renderStationsTable();
            renderLogs();
            renderUsers();
        }

        function saveData() {
            localStorage.setItem('gs_stations', JSON.stringify(stations));
            localStorage.setItem('gs_logs', JSON.stringify(logs));
            localStorage.setItem('gs_users', JSON.stringify(users));
        }

        // --- Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // Update Title
            const titles = { 'dashboard': 'لوحة المعلومات', 'stations': 'جدول المحطات', 'history': 'سجل العمليات', 'settings': 'الإعدادات' };
            document.getElementById('pageTitle').textContent = titles[pageId];

            // Nav Styles
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('active-nav', 'bg-blue-50', 'text-blue-600');
                b.classList.add('text-slate-600');
            });
            const btn = document.getElementById(`nav-${pageId}`);
            btn.classList.add('active-nav');
            btn.classList.remove('text-slate-600');

            if(pageId === 'dashboard') {
                updateDashboard();
                setTimeout(() => { if(mapInstance) mapInstance.invalidateSize(); }, 100);
            }
        }

        // --- Dashboard & Charts ---
        let chartInstances = {};

        function updateDashboard() {
            // KPIs
            document.getElementById('statTotal').textContent = stations.length;
            document.getElementById('statOpen').textContent = stations.filter(s => s.status === 'مفتوحة').length;
            document.getElementById('statDev').textContent = stations.filter(s => ['تحت الإنشاء', 'تحت التطوير', 'تحت التأهيل'].includes(s.status)).length;
            document.getElementById('statActiveContracts').textContent = stations.filter(s => s.contractType === 'ساري').length;

            if(stations.length === 0) return;

            // Update Map
            updateMapMarkers();

            // Helpers
            const count = (f) => {
                const c = {};
                stations.forEach(s => { const v = s[f] || 'غير محدد'; c[v] = (c[v]||0)+1; });
                return c;
            };

            // 1. Region (Bar)
            drawChart('regionChart', 'bar', count('region'), colors.primary);
            // 2. Main City (Doughnut)
            drawChart('mainCityChart', 'doughnut', count('isMainCity'), [colors.success, colors.secondary]);
            // 3. Op Type (Pie)
            drawChart('operationTypeChart', 'pie', count('operationType'), [colors.primary, colors.purple, colors.orange, colors.info]);
            // 4. Status (Pie)
            drawChart('statusChart', 'pie', count('status'), [colors.success, colors.danger, colors.warning, colors.purple, colors.info]);
            // 5. Road (Doughnut)
            drawChart('roadTypeChart', 'doughnut', count('roadType'), [colors.warning, colors.slate]);
            // 6. Contract (Doughnut)
            drawChart('contractStatusChart', 'doughnut', count('contractType'), [colors.success, colors.warning, colors.danger]);
            // 7. Map Status (Doughnut)
            drawChart('mapStatusChart', 'doughnut', count('mapStatus'), [colors.primary, colors.danger]);
            // 8. Branding (Pie)
            drawChart('brandingChart', 'pie', count('branding'), [colors.primary, colors.secondary]);
            // 9. Fuel (Bar)
            const fuel = { '91':0, '95':0, '98':0, 'D':0 };
            stations.forEach(s => { if(s.fuelType) s.fuelType.forEach(f => fuel[f] = (fuel[f]||0)+1); });
            drawChart('fuelTypeChart', 'bar', fuel, [colors.success, colors.danger, colors.purple, colors.slate]);
        }

        function drawChart(id, type, dataObj, colorSet) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();

            const labels = Object.keys(dataObj);
            const values = Object.values(dataObj);
            const sum = values.reduce((a,b)=>a+b, 0);

            // Handle single color vs array
            let bgColors = colorSet;
            if (typeof colorSet === 'string') bgColors = colorSet; // single color for bars

            chartInstances[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        borderRadius: type === 'bar' ? 4 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, font: {family: 'Tajawal', size: 11} } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 10, family: 'Tajawal' },
                            formatter: (val) => val > 0 ? val + `\n(${Math.round(val/sum*100)}%)` : '',
                            display: (ctx) => {
                                // Hide label if segment is too small (less than 5%)
                                return (ctx.dataset.data[ctx.dataIndex] / sum) > 0.05; 
                            },
                            textAlign: 'center'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            padding: 12,
                            titleFont: { family: 'Tajawal' },
                            bodyFont: { family: 'Tajawal' }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#e2e8f0' } },
                        x: { grid: { display: false } }
                    } : {}
                }
            });
        }

        // --- MAP FUNCTIONS (Leaflet) ---
        function initMap() {
            if(mapInstance) return;

            // Default center (Riyadh)
            mapInstance = L.map('stationsMap').setView([24.7136, 46.6753], 5);
            
            // CartoDB Voyager Tiles (Clean, Professional looking)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(mapInstance);

            markersLayer = L.layerGroup().addTo(mapInstance);
            
            // Create Legend
            const legendDiv = document.getElementById('mapLegend');
            legendDiv.innerHTML = '';
            Object.entries(opTypeColors).forEach(([type, color]) => {
                if(type === 'أخرى') return;
                legendDiv.innerHTML += `
                    <div class="flex items-center gap-1">
                        <span class="w-3 h-3 rounded-full" style="background:${color}"></span>
                        <span class="text-slate-600">${type}</span>
                    </div>
                `;
            });

            updateMapMarkers();
        }

        function updateMapMarkers() {
            if(!mapInstance || !markersLayer) return;
            markersLayer.clearLayers();

            const bounds = [];

            stations.forEach(s => {
                if(s.coordY && s.coordX) {
                    const lat = parseFloat(s.coordY);
                    const lng = parseFloat(s.coordX);
                    
                    if(!isNaN(lat) && !isNaN(lng)) {
                        // Determine Color based on Op Type
                        const color = opTypeColors[s.operationType] || opTypeColors['أخرى'];
                        
                        // Custom Marker Icon
                        const iconHtml = `
                            <div style="background-color: ${color}; width: 1.5rem; height: 1.5rem; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                <i class="fa-solid fa-gas-pump text-white text-[0.6rem]"></i>
                            </div>
                        `;
                        
                        const icon = L.divIcon({
                            className: 'custom-map-marker',
                            html: iconHtml,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });

                        const marker = L.marker([lat, lng], {icon: icon})
                            .bindPopup(`
                                <div class="font-tajawal text-right dir-rtl">
                                    <h4 class="font-bold text-blue-600 mb-1">${s.code}</h4>
                                    <div class="text-xs text-slate-600">
                                        <p><b>المنطقة:</b> ${s.region}</p>
                                        <p><b>التشغيل:</b> ${s.operationType}</p>
                                        <p><b>الحالة:</b> ${s.status}</p>
                                    </div>
                                </div>
                            `);
                        
                        markersLayer.addLayer(marker);
                        bounds.push([lat, lng]);
                    }
                }
            });

            if(bounds.length > 0) {
                mapInstance.fitBounds(bounds, {padding: [50, 50]});
            }
        }


        // --- Stations Logic (Edit, Delete, Add) ---
        let editingIndex = -1;

        function renderStationsTable() {
            const tbody = document.getElementById('stationsTableBody');
            tbody.innerHTML = '';
            const search = document.getElementById('searchInput').value.toLowerCase();

            stations.forEach((s, index) => {
                if (search && !Object.values(s).some(val => String(val).toLowerCase().includes(search))) return;
                
                let badgeClass = 'bg-slate-100 text-slate-600';
                if(s.status === 'مفتوحة') badgeClass = 'bg-emerald-100 text-emerald-700';
                if(s.status === 'مغلقة') badgeClass = 'bg-red-100 text-red-700';
                if(s.status === 'تحت الإنشاء') badgeClass = 'bg-amber-100 text-amber-700';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-50 last:border-0";
                tr.innerHTML = `
                    <td class="p-4 font-bold text-blue-600">${s.code}</td>
                    <td class="p-4 text-slate-600">${s.region}</td>
                    <td class="p-4 text-slate-600">${s.city}</td>
                    <td class="p-4 text-slate-500 text-xs">${s.district}</td>
                    <td class="p-4"><span class="px-2.5 py-1 rounded-full text-xs font-bold ${badgeClass}">${s.status}</span></td>
                    <td class="p-4 text-slate-600">${s.operationType}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="editStation(${index})" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteStation(${index})" class="w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ... (Modal logic remains largely same, just calling updateMapMarkers() on save) ...

        function openStationModal() {
            editingIndex = -1;
            document.getElementById('stationForm').reset();
            let nextNum = 1;
            if (stations.length > 0) {
                const nums = stations.map(s => parseInt(s.code.replace('GO', '')) || 0);
                nextNum = Math.max(...nums) + 1;
            }
            document.getElementById('input_code').value = 'GO' + nextNum;
            document.getElementById('modalTitle').textContent = 'إضافة محطة جديدة';
            document.getElementById('stationModal').classList.remove('hidden');
        }

        function closeStationModal() { document.getElementById('stationModal').classList.add('hidden'); }

        function editStation(idx) {
            editingIndex = idx;
            const s = stations[idx];
            document.getElementById('modalTitle').textContent = `تعديل: ${s.code}`;
            const form = document.getElementById('stationForm');
            for(const k in s) {
                if(k!=='fuelType' && form.elements[k]) form.elements[k].value = s[k];
            }
            document.querySelectorAll('input[name="fuelType"]').forEach(cb => {
                cb.checked = s.fuelType && s.fuelType.includes(cb.value);
            });
            document.getElementById('stationModal').classList.remove('hidden');
        }

        function saveStation() {
            const form = document.getElementById('stationForm');
            const fd = new FormData(form);
            const data = Object.fromEntries(fd.entries());
            data.fuelType = [];
            document.querySelectorAll('input[name="fuelType"]:checked').forEach(c => data.fuelType.push(c.value));

            if(editingIndex === -1) {
                stations.push(data);
                addLog('إضافة', `إضافة محطة ${data.code}`);
            } else {
                data.code = stations[editingIndex].code;
                stations[editingIndex] = data;
                addLog('تعديل', `تعديل محطة ${data.code}`);
            }
            saveData();
            renderStationsTable();
            closeStationModal();
            updateDashboard();
        }

        function deleteStation(idx) {
            if(confirm('تأكيد الحذف؟')) {
                const s = stations.splice(idx, 1)[0];
                addLog('حذف', `حذف محطة ${s.code}`);
                saveData();
                renderStationsTable();
                updateDashboard();
            }
        }

        // --- Utils ---
        function parseGoogleCoordinates(url) {
            if(!url) return;
            const regexAt = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
            const regexLoc = /q=loc:(-?\d+\.\d+),(-?\d+\.\d+)/;
            const regexSimple = /(-?\d+\.\d+),\s*(-?\d+\.\d+)/;
            let match = url.match(regexAt) || url.match(regexLoc) || url.match(regexSimple);
            if (match) {
                document.getElementById('input_coordY').value = match[1];
                document.getElementById('input_coordX').value = match[2];
            }
        }

        function addLog(act, det) {
            logs.unshift({ date: new Date().toLocaleString('ar-SA'), user: currentUser?.username||'System', action: act, details: det });
            if(logs.length>200) logs.pop();
            saveData();
            renderLogs();
        }

        function renderLogs() {
            const tb = document.getElementById('historyTableBody');
            tb.innerHTML = '';
            logs.forEach(l => {
                tb.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-50 text-slate-600"><td class="p-3 dir-ltr text-right font-mono text-xs">${l.date}</td><td class="p-3 font-bold text-blue-600">${l.user}</td><td class="p-3"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">${l.action}</span></td><td class="p-3 text-xs">${l.details}</td></tr>`;
            });
        }

        // --- Users ---
        function renderUsers() {
            const tb = document.getElementById('usersTableBody');
            tb.innerHTML = '';
            users.forEach((u, i) => {
                tb.innerHTML += `<tr><td class="p-3">${u.username}</td><td class="p-3 font-mono">****</td><td class="p-3 text-center">${u.username!=='admin'?`<button onclick="deleteUser(${i})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>`:'-'}</td></tr>`;
            });
        }
        function openUserModal() { document.getElementById('userModal').classList.remove('hidden'); }
        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }
        function saveUser() {
            const u=document.getElementById('newUsername').value, p=document.getElementById('newPassword').value;
            if(u&&p) { users.push({username:u, password:p}); saveData(); renderUsers(); closeUserModal(); addLog('مستخدم', `إضافة ${u}`); }
        }
        function deleteUser(i) { if(confirm('حذف؟')){ users.splice(i,1); saveData(); renderUsers(); } }

        // --- File System ---
        async function linkAutoSaveFile() {
            if ('showOpenFilePicker' in window) {
                try {
                    [fileHandle] = await window.showOpenFilePicker({types:[{description:'Excel',accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx']}}]});
                    if ((await fileHandle.queryPermission({mode:'readwrite'}))!=='granted' && (await fileHandle.requestPermission({mode:'readwrite'}))!=='granted') return;

                    // Import initial if exists
                    const f = await fileHandle.getFile(), ab = await f.arrayBuffer();
                    if(ab.byteLength>0) {
                        try {
                            const wb = XLSX.read(ab), jd = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            if(jd.length>0 && confirm('وجدنا بيانات. استيراد؟')) {
                                stations = jd.map(r => { if(typeof r.fuelType==='string') r.fuelType=r.fuelType.split(',').map(x=>x.trim()); return r; });
                                saveData(); updateDashboard(); renderStationsTable();
                            }
                        } catch(e){}
                    }
                    
                    document.getElementById('fileLinkStatus').className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.6)]';
                    document.getElementById('btnLinkFile').innerHTML = '<i class="fa-solid fa-check"></i> تم الربط';
                    document.getElementById('btnLinkFile').classList.replace('bg-slate-800','bg-green-600');
                    alert('تم الربط بنجاح');
                } catch(e) { console.error(e); }
            } else alert('غير مدعوم في هذا المتصفح');
        }

        async function autoSaveSystem() {
            saveData();
            if(fileHandle) {
                try {
                    document.getElementById('autoSaveStatus').textContent = 'جاري الحفظ...';
                    const exp = stations.map(s => { const r={...s}; if(Array.isArray(r.fuelType)) r.fuelType=r.fuelType.join(','); return r; });
                    const ws = XLSX.utils.json_to_sheet(exp), wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Stations");
                    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                    const w = await fileHandle.createWritable(); await w.write(wbout); await w.close();
                    document.getElementById('autoSaveStatus').textContent = 'تم الحفظ: ' + new Date().toLocaleTimeString('en-US',{hour12:false});
                    document.getElementById('autoSaveStatus').className = 'text-[10px] text-green-600 font-bold mb-3 truncate';
                } catch(e) {
                    document.getElementById('autoSaveStatus').textContent = 'فشل الحفظ';
                    document.getElementById('autoSaveStatus').className = 'text-[10px] text-red-500 font-bold mb-3 truncate';
                }
            }
        }

        // Export/Import/Template...
        function downloadTemplate() {
            const ws=XLSX.utils.json_to_sheet([{code:"GO1", prevName:"مثال", region:"الرياض", city:"الرياض", district:"...", street:"...", isMainCity:"نعم", roadType:"...", mapLink:"...", mapStatus:"...", coordX:"", coordY:"", area:1000, status:"مفتوحة", openingDate:"", contractType:"ساري", operationType:"تشغيل", branding:"...", ownerName:"...", ownerPhone:"", fuelType:"91, 95", eContractLink:"", filesLink:"", photosLink:"", ratingLink:"", supervisorName:"", supervisorPhone:""}]);
            const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template"); XLSX.writeFile(wb,"GoStation_Template.xlsx");
        }
        function exportToExcel() {
            const exp = stations.map(s => { const r={...s}; if(Array.isArray(r.fuelType)) r.fuelType=r.fuelType.join(','); return r; });
            const ws=XLSX.utils.json_to_sheet(exp), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Stations"); XLSX.writeFile(wb,`GoStation_Backup_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        function importFromExcel(inp) {
            const f=inp.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=e=>{
                const d=new Uint8Array(e.target.result), wb=XLSX.read(d,{type:'array'}), jd=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(confirm(`استيراد ${jd.length} سجل؟`)){
                    stations=jd.map(r=>{if(typeof r.fuelType==='string')r.fuelType=r.fuelType.split(',').map(x=>x.trim());return r;});
                    saveData(); updateDashboard(); renderStationsTable(); alert('تم');
                }
            }; r.readAsArrayBuffer(f); inp.value='';
        }
    </script>
    <div style="padding: 20px; background: #f0f0f0; border: 1px solid #ccc; margin: 20px 0;">
  <h3>منطقة تجربة الربط</h3>
  <button onclick="fetchData()">جلب البيانات من الشيت (تحديث)</button>
  <button onclick="testSend()">إرسال بيانات تجريبية للشيت</button>
  <p id="status-msg" style="color: blue;"></p>
</div>

<script>
  // 1. رابط السكربت الخاص بك
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyc7SPsyCREC7MR3Je3sk0J0NPlVuFM9ZzZBjDCPhZvl79_WJDkquSTCo7HUHOETuGU/exec";

  // 2. دالة لجلب البيانات من الشيت
  function fetchData() {
    document.getElementById("status-msg").innerText = "جاري جلب البيانات...";
    
    fetch(GOOGLE_SCRIPT_URL)
      .then(response => response.json())
      .then(data => {
        if (data.status === "success") {
          console.log("البيانات المستلمة:", data.data);
          document.getElementById("status-msg").innerText = "تم جلب البيانات بنجاح! راجع الـ Console (F12)";
          
          // هنا يمكنك إضافة كود لتحديث عناصر الداش بورد بناءً على data.data
        }
      })
      .catch(error => {
        console.error("خطأ:", error);
        document.getElementById("status-msg").innerText = "حدث خطأ في الاتصال";
      });
  }

  // 3. دالة لإرسال بيانات (مثال لاستخدامه في نماذج الإدخال)
  function sendData(dataArray) {
    // نستخدم 'no-cors' لتجنب مشاكل المتصفح مع السكربتات الخارجية أحياناً، 
    // ولكن الطريقة القياسية هي POST عادي. سنجرب الطريقة العادية أولاً.
    
    fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ values: dataArray })
    })
    .then(response => response.json())
    .then(data => {
      console.log("تم الإرسال:", data);
      document.getElementById("status-msg").innerText = "تم حفظ البيانات في الشيت بنجاح!";
      
      // تحديث البيانات بعد الإرسال لرؤية التغيير
      fetchData(); 
    })
    .catch(error => {
      console.error("خطأ في الإرسال:", error);
      document.getElementById("status-msg").innerText = "فشل الإرسال، تأكد من الصلاحيات";
    });
  }

  // 4. دالة تجربة الإرسال (مرتبطة بالزر التجريبي أعلاه)
  function testSend() {
    document.getElementById("status-msg").innerText = "جاري الإرسال...";
    // سنرسل صفاً تجريبياً يحتوي على: الاسم، الوظيفة، التاريخ
    var testRow = ["جواد", "تجربة من الداش بورد", new Date().toLocaleTimeString()];
    sendData(testRow);
  }

  // تشغيل جلب البيانات تلقائياً عند فتح الصفحة
  window.onload = fetchData;
</script>
</body>
</html>

